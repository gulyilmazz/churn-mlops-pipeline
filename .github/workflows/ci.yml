name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  python-checks:
    name: Python Syntax & Import Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Python syntax check
      run: |
        echo "ğŸ” Python syntax kontrolÃ¼..."
        python -m py_compile src/api/app.py
        python -m py_compile src/models/train.py
        python -m py_compile src/data/preprocess.py
        python -m py_compile src/inference/predict.py
        echo "âœ… Syntax kontrolÃ¼ baÅŸarÄ±lÄ±"
    
    - name: Import test
      run: |
        echo "ğŸ” Import testi..."
        python -c "from src.api.app import app; print('âœ… API import baÅŸarÄ±lÄ±')"
        python -c "from src.data.preprocess import preprocess; print('âœ… Preprocess import baÅŸarÄ±lÄ±')"
        python -c "from src.models.train import train; print('âœ… Train import baÅŸarÄ±lÄ±')"
        echo "âœ… TÃ¼m import testleri baÅŸarÄ±lÄ±"
    
    - name: Check model file exists
      run: |
        if [ -f "artifacts/churn_model.joblib" ]; then
          echo "âœ… Model dosyasÄ± mevcut"
        else
          echo "âš ï¸ Model dosyasÄ± bulunamadÄ± (opsiyonel)"
        fi

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: python-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build API Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: churn-api:test
        cache-from: type=registry,ref=churn-api:buildcache
        cache-to: type=inline
    
    - name: Verify Docker image
      run: |
        echo "ğŸ” Docker image doÄŸrulamasÄ±..."
        docker images churn-api:test
        echo "âœ… Docker image baÅŸarÄ±yla oluÅŸturuldu"

